
    <!DOCTYPE html>
    <html lang="pt">
    <head>
        <meta charset="UTF-8">
        <title>Doorzo Scraper Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body { 
                background-image: url('/assets/latias.jpg');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                color: #f8fafc; 
                font-family: sans-serif; 
            }
            .card { 
                background: rgba(30, 41, 59, 0.7); 
                backdrop-filter: blur(10px);
                border: 1px solid rgba(51, 65, 85, 0.5); 
                border-radius: 12px; 
                padding: 20px; 
            }
            .accent { color: #f59e0b; }
            .progress-bar { transition: width 0.3s ease-in-out; }
            .btn { transition: all 0.2s; }
            .btn:hover { transform: scale(1.02); }
            .btn-stop { background: #dc2626; }
            .btn-stop:hover { background: #b91c1c; }
            .btn-start { background: #16a34a; }
            .btn-start:hover { background: #15803d; }
            .btn-download { background: #0e7490; }
            .btn-download:hover { background: #155e75; }
        </style>
    </head>
    <body class="p-8">
        <div class="max-w-6xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold accent">Doorzo Scraper <span class="text-white text-sm font-normal">Controle Manual</span></h1>
                    <p class="text-slate-400">Gerenciamento de minera√ß√£o perp√©tua</p>
                </div>
                <div class="flex gap-4 items-center">
                    <a href="/api/download" id="download-btn" class="btn btn-download px-6 py-2 rounded-lg font-bold shadow-lg">Download Cat√°logo</a>
                    <button onclick="startScraper()" id="start-btn" class="btn btn-start px-6 py-2 rounded-lg font-bold shadow-lg" style="display: none;">Iniciar Bot</button>
                    <button onclick="stopScraper()" id="stop-btn" class="btn btn-stop px-6 py-2 rounded-lg font-bold shadow-lg">Finalizar e Salvar Agora</button>
                    <div id="status-badge" class="px-4 py-2 rounded-full bg-blue-600 text-sm font-bold uppercase tracking-wider flex items-center">Carregando...</div>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-7 gap-6 mb-8">
                <div class="card">
                    <p class="text-slate-400 text-sm">No Banco de Dados</p>
                    <p id="total-items" class="text-4xl font-bold mt-2">-</p>
                </div>
                <div class="card">
                    <p class="text-slate-400 text-sm">Itens Encontrados</p>
                    <p id="total-items-found" class="text-4xl font-bold mt-2">-</p>
                </div>
                <div class="card">
                    <p class="text-slate-400 text-sm">Lotes Abertos</p>
                    <p id="lots-found" class="text-4xl font-bold mt-2">-</p>
                </div>
                <div class="card">
                    <p class="text-slate-400 text-sm">Novos Minerados</p>
                    <p id="new-items" class="text-4xl font-bold mt-2 text-green-400">-</p>
                </div>
                <div class="card">
                    <p class="text-slate-400 text-sm">Itens Falhos</p>
                    <p id="failed-items" class="text-4xl font-bold mt-2 text-red-500">-</p>
                </div>
                <div class="card col-span-2">
                    <p class="text-slate-400 text-sm">√öltimo Console Encontrado</p>
                    <p id="last-scraped" class="text-xl font-bold mt-3 truncate">-</p>
                </div>
            </div>

            <div id="progress-section" class="mb-8" style="display: none;">
                <div class="flex justify-between mb-2 text-sm font-medium">
                    <span>Progresso de Minera√ß√£o (Novos Itens)</span>
                    <span id="progress-text" class="accent">0/0</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-4">
                    <div id="progress-fill" class="bg-amber-500 h-4 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-bold mb-4">üìã Console Geral</h2>
                    <div id="log-container" class="h-96 overflow-y-auto text-sm font-mono space-y-1 bg-black/30 p-4 rounded-lg"></div>
                </div>
                <div>
                    <div class="card mb-6">
                        <p class="text-slate-400 text-sm">Runtime</p>
                        <p id="runtime" class="text-4xl font-bold mt-2">-</p>
                    </div>
                    <div class="card mb-6">
                        <h2 class="text-xl font-bold mb-4">Configura√ß√µes de Busca</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="searchTerm" class="block text-sm font-medium text-slate-300">Termo de Busca Principal</label>
                                <input type="text" id="searchTerm" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Palavras-chave de Filtragem</label>
                                <div id="keywords-container" class="mt-2 space-y-2"></div>
                                <div class="flex gap-2 mt-2">
                                    <input type="text" id="newKeyword" placeholder="Adicionar palavra-chave" class="block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                                    <button onclick="addKeyword()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">+</button>
                                </div>
                            </div>
                            <button onclick="saveConfig()" class="w-full btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-md">Salvar Configura√ß√µes</button>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Faixas de Pre√ßo</h2>
                        <div id="price-ranges-container" class="space-y-2"></div>
                        <div class="flex gap-2 mt-2">
                            <input type="number" id="new-price-min" placeholder="M√≠n" class="block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                            <input type="number" id="new-price-max" placeholder="M√°x" class="block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                            <button onclick="addPriceRange()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">+</button>
                        </div>
                        <div class="mt-6 text-sm text-slate-500">
                            <p class="mb-2 font-bold text-slate-300">Regras de Salvamento:</p>
                            <ul class="list-disc ml-4 space-y-2">
                                <li>Se usar o bot√£o "Finalizar": <span class="text-blue-400">Anexa</span> novos itens ao banco atual. N√£o deleta nada.</li>
                                <li>No fim do ciclo autom√°tico: <span class="text-green-400">Limpa</span> itens que sa√≠ram de venda do banco de dados.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            let currentKeywords = [];
            let currentPriceRanges = [];

            async function startScraper() {
                if(!confirm("Deseja iniciar o ciclo de minera√ß√£o?")) return;
                try {
                    await fetch('/api/start', { method: 'POST' });
                    startBtn.innerText = "Iniciando...";
                    startBtn.disabled = true;
                } catch(e) {
                    console.error("Falha ao iniciar:", e);
                    startBtn.disabled = false;
                    startBtn.innerText = "Iniciar Bot";
                }
            }

            async function stopScraper() {
                if(!confirm("Deseja interromper a minera√ß√£o e salvar os itens capturados at√© agora? O bot ficar√° pausado at√© ser iniciado novamente.")) return;
                try {
                    await fetch('/api/stop', { method: 'POST' });
                    stopBtn.innerText = "Encerrando...";
                    stopBtn.disabled = true;
                } catch(e) {
                    console.error("Falha ao parar:", e);
                }
            }

            function renderKeywords() {
                const container = document.getElementById('keywords-container');
                container.innerHTML = currentKeywords.map((kw, index) => `
                    <div class="flex justify-between items-center bg-slate-700 p-2 rounded-md">
                        <span>${kw}</span>
                        <button onclick="removeKeyword(${index})" class="text-red-500 hover:text-red-700 font-bold">X</button>
                    </div>
                `).join('');
            }

            function addKeyword() {
                const input = document.getElementById('newKeyword');
                const keyword = input.value.trim().toLowerCase();
                if (keyword && !currentKeywords.includes(keyword)) {
                    currentKeywords.push(keyword);
                    renderKeywords();
                    input.value = '';
                }
            }

            function removeKeyword(index) {
                currentKeywords.splice(index, 1);
                renderKeywords();
            }

            function renderPriceRanges() {
                const container = document.getElementById('price-ranges-container');
                currentPriceRanges.sort((a, b) => a.min - b.min);
                container.innerHTML = currentPriceRanges.map((range, index) => `
                    <div class="flex justify-between items-center bg-slate-700 p-2 rounded-md">
                        <span>¬•${range.min.toLocaleString()} - ¬•${range.max.toLocaleString()}</span>
                        <button onclick="removePriceRange(${index})" class="text-red-500 hover:text-red-700 font-bold">X</button>
                    </div>
                `).join('');
            }

            function addPriceRange() {
                const minInput = document.getElementById('new-price-min');
                const maxInput = document.getElementById('new-price-max');
                const min = parseInt(minInput.value);
                const max = parseInt(maxInput.value);

                if (isNaN(min) || isNaN(max) || min <= 0 || max <= 0) {
                    alert("Valores de pre√ßo inv√°lidos.");
                    return;
                }

                if (min >= max) {
                    alert("O pre√ßo m√≠nimo deve ser menor que o m√°ximo.");
                    return;
                }

                const overlaps = currentPriceRanges.some(range =>
                    (min >= range.min && min <= range.max) ||
                    (max >= range.min && max <= range.max) ||
                    (min <= range.min && max >= range.max)
                );

                if (overlaps) {
                    alert("A faixa de pre√ßo se sobrep√µe com uma existente.");
                    return;
                }

                currentPriceRanges.push({ min, max });
                renderPriceRanges();
                minInput.value = '';
                maxInput.value = '';
            }

            function removePriceRange(index) {
                currentPriceRanges.splice(index, 1);
                renderPriceRanges();
            }

            async function saveConfig() {
                const searchTerm = document.getElementById('searchTerm').value;
                const newConfig = {
                    searchTerm: searchTerm,
                    searchKeywords: currentKeywords,
                    priceRanges: currentPriceRanges
                };

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newConfig)
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Configura√ß√µes salvas com sucesso!');
                    } else {
                        alert('Falha ao salvar configura√ß√µes: ' + result.message);
                    }
                } catch (e) {
                    console.error("Falha ao salvar config:", e);
                    alert('Erro de comunica√ß√£o com o servidor.');
                }
            }
            
            async function loadConfig() {
                try {
                    const res = await fetch('/api/config');
                    const config = await res.json();
                    document.getElementById('searchTerm').value = config.searchTerm || '';
                    currentKeywords = config.searchKeywords || [];
                    currentPriceRanges = config.priceRanges || [];
                    renderKeywords();
                    renderPriceRanges();
                } catch (e) {
                    console.error("Failed to load config:", e);
                }
            }

            async function updateDashboard() {
                try {
                    const res = await fetch('/api/stats');
                    const data = await res.json();
                    
                    document.getElementById('status-badge').innerText = data.status;
                    const statusClass = {
                        'Minerando Descri√ß√µes': 'bg-amber-600',
                        'Pesquisando': 'bg-blue-600',
                        'Em Espera': 'bg-green-600',
                        'Parado': 'bg-slate-600',
                        'Aguardando comando': 'bg-slate-600',
                        'Erro Cr√≠tico': 'bg-red-800'
                    }[data.status] || 'bg-gray-600';
                    document.getElementById('status-badge').className = `px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wider flex items-center ${statusClass}`;
                    
                    // Controle dos bot√µes
                    if (data.status === 'Parado' || data.status === 'Aguardando comando' || data.status === 'Erro Cr√≠tico') {
                        startBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        startBtn.disabled = false;
                        startBtn.innerText = "Iniciar Bot";
                    } else {
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'inline-block';
                        stopBtn.disabled = false;
                        stopBtn.innerText = "Finalizar e Salvar Agora";
                    }


                    document.getElementById('total-items').innerText = data.totalItems || 0;
                    document.getElementById('total-items-found').innerText = data.totalItemsFound || 0;
                    document.getElementById('lots-found').innerText = data.lotsFound || 0;
                    document.getElementById('new-items').innerText = '+' + (data.newItemsLastCycle || 0);
                    document.getElementById('failed-items').innerText = data.failedItemsCount || 0;
                    
                    const seconds = data.uptime || 0;
                    const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                    const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    document.getElementById('runtime').innerText = `${h}:${m}:${s}`;
                    
                    document.getElementById('last-scraped').innerText = data.lastScrapedName || '-';
                    document.getElementById('current-range').innerText = data.currentRange || "N/A";
                    
                    if(data.progressTotal > 0) {
                        document.getElementById('progress-section').style.display = 'block';
                        document.getElementById('progress-text').innerText = data.progressCurrent + ' / ' + data.progressTotal;
                        const pct = Math.floor((data.progressCurrent / data.progressTotal) * 100);
                        document.getElementById('progress-fill').style.width = pct + '%';
                    } else {
                        document.getElementById('progress-section').style.display = 'none';
                    }

                    const logBox = document.getElementById('log-container');
                    logBox.innerHTML = (data.logs || []).map(log => `<div class="border-b border-white/5 pb-1">${log}</div>`).join('');
                } catch (e) {
                    console.error("Dashboard update failed:", e);
                     document.getElementById('status-badge').innerText = "Offline";
                     document.getElementById('status-badge').className = "px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wider flex items-center bg-red-800";
                }
            }
            setInterval(updateDashboard, 1500);
            updateDashboard(); // Initial call
            loadConfig(); // Load config on page load

            // --- Diagnostics ---
            function pingServer() {
                fetch('/api/ping')
                    .then(res => res.json())
                    .then(data => console.log('Ping OK:', data))
                    .catch(err => console.error('Ping FAILED:', err));
            }
            setInterval(pingServer, 5000);
        </script>
    </body>
    </html>
  